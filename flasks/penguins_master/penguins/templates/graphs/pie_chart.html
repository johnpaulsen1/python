<!doctype html>
<link rel="stylesheet" href="/static/style.css" type="text/css">
<link rel="stylesheet" href="/static/style/graphs-style.css" type="text/css">
<head>
  <title>{{ title }}</title>
  <script src="/static/javascript/colour_randomiser.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.js" integrity="sha512-vJLAMsHIpI7ORUMpudTJNz+wRNnPQAkHVlnpgpVxXI0lPnKcQ38Psu0APJ2r3nhhBHNIcQPRVrlkHiAeQHADTA==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.piecelabel.js/0.15.0/Chart.PieceLabel.min.js" integrity="sha512-pLEKa6g1uR205lfWRPuxwUa/aw1Yge1jOCvYr5WCL68gh3FoLi0eqMsIEtCvIXgZY0LwiRoMgiTfrpX7pK1HFA==" crossorigin="anonymous"></script>
</head>

<body>
  <form method="POST">
    <div class="graph_menu-screen">
    <center>
      <h2>{{ title }}</h2>
      <div class="control-group-small radio-buttons-label">
        <p>Please select graph type:</p>
      </div>
      <div class="control-group-small general-radio-buttons">
        <input type="radio" id="bar" name="graph_type" value="Bar Graph" onclick="handleClick(this);">
        <label class="radio-labels" for="bar">Bar Graph</label><br>

        <input type="radio" id="pie" name="graph_type" value="Pie Graph" checked onclick="handleClick(this);">
        <label class="radio-labels" for="pie">Pie Graph</label><br>
      </div>
      <div class="control-group">
        <canvas id="chart"></canvas>
      </div>
      <div class="control-group">
        <input type="submit" value="Back" class="floated_left_btn btn btn-back" name="submit_button">
        <input type="submit" value="Log Out" class="floated_right_btn btn btn-logout" name="submit_button">
      </div>
    </center>
    <script>

    var prev_radio_value = 0;

    function handleClick(myRadio) {
      var static_bar_value = "Bar Graph"
      var static_pie_value = "Pie Graph"

      if (prev_radio_value != static_bar_value && myRadio.value == static_bar_value){
        window.location.href = "{{url_for('bar')}}"
        prev_radio_value = myRadio.value
      }
      else if (prev_radio_value != static_pie_value && myRadio.value == static_pie_value){
        window.location.href = "{{url_for('pie')}}"
        prev_radio_value = myRadio.value
      }
    }

    var canvasChart = document.getElementById('chart');
    var ctx = canvasChart.getContext('2d');

    ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontColor="#a64b00",
                                        Chart.defaults.global.defaultFontFamily
                                      );

    var myChart = new Chart(ctx,{
      type: 'pie',
      data: {
        labels: [
          {% for label in labels %}
           "{{ label }}",
          {% endfor %}
        ],
        datasets: [{
          data: [
            {% for value in values %}
             "{{ value }}",
            {% endfor %}
          ],
          backgroundColor: [
            {% for value in values %}
             getRandomCyanColour(),
            {% endfor %}
          ],
          borderColor: [
            {% for value in values %}
             getRandomOrangeColour(),
            {% endfor %}
          ],
          borderWidth: 2
        }]
      },
      options: {
        pieceLabel: {
          mode: "value",
          fontSize: 14,
          fontStyle: 'bold',
          position: 'outside',
        }
      }
    });

    canvasChart.onclick = function(e) {
      var selected_slice = myChart.getElementAtEvent(e);
      if (! selected_slice.length) return;
      var setURL = "{{ url_for('set_graph_results_decomm_db') }}";
      var displayURL = "{{ url_for('display_search_info_decomm_db') }}";
      var displayAllURL = "{{ url_for('decomm_show_all_decomm_db') }}";
      var slice = selected_slice[0]._model.label;

      if (slice != 'Total' && typeof slice !== 'undefined'){
        $.ajax({
          type: "POST",
          url: setURL,
          contentType: "application/json",
          data: JSON.stringify({search_for: slice}),
          dataType: "json",
          success: function(response) {
            console.log(response);
            window.open(displayURL);
          },
          error: function(err) {
            console.log(err);
          }
        });
      }
      else if (slice == 'Total' && typeof slice !== 'undefined'){
        window.open(displayAllURL);
      }
    }

    </script>
    </div>
  </form>
</body>
</html>
